/* :file: This file is part of the pgRouting project.
:copyright: Copyright (c) 2018-2026 pgRouting developers
:license: Creative Commons Attribution-Share Alike 3.0 https://creativecommons.org/licenses/by-sa/3.0 */

CREATE OR REPLACE FUNCTION no_crash_test(func TEXT, params TEXT[], subs TEXT[])
RETURNS SETOF TEXT AS
$BODY$
DECLARE
mp TEXT[];
q1 TEXT;
q TEXT;
separator TEXT;
BEGIN
    FOR i IN 0..array_length(params, 1) LOOP
        separator = ' ';
        mp := params;
        IF i != 0 THEN
            mp[i] = subs[i];
        END IF;

        q1 := 'SELECT * FROM ' || $1 || ' (';

        FOR i IN 1..array_length(mp, 1) LOOP
            q1 := q1 || separator || mp[i];
            separator :=',';
        END LOOP;

        q1 := q1 || ')';

        --RAISE WARNING '%', q1;


        RETURN query SELECT * FROM lives_ok(q1, 'lives_ok ' || q1);
        IF i = 0 THEN
            RETURN query SELECT * FROM isnt_empty(q1, 'isnt_empty ' || q1);
        ELSE
            IF func='pgr_isplanar' THEN
                RETURN query SELECT * FROM isnt_empty(q1, 'isnt_empty' || q1);
            ELSIF func='pgr_maxFlow' OR func='pgr_maxFlowMinCost_Cost' OR func = 'pgr_bandwidth' THEN
                RETURN query SELECT * FROM set_eq(q1, 'SELECT NULL::BIGINT', 'set_eq' || q1);
            ELSE
                RETURN query SELECT * FROM is_empty(q1, 'is_empty' || q1);
            END IF;
        END IF;

    END LOOP;

END
$BODY$
LANGUAGE plpgsql VOLATILE;

CREATE OR REPLACE FUNCTION throw_on_empty_edges_sql(func TEXT, params TEXT)
RETURNS SETOF TEXT AS
$BODY$
DECLARE
tquery TEXT;
BEGIN

  tquery := $$SELECT * FROM $$ || $1 || $$ ('' $$ || $2 || ')';
  IF (min_lib_version('4.1.0')) THEN
    RETURN query
    SELECT * FROM throws_ok( tquery, 'XX000', 'Empty edges SQL', 'throws_ok: ' || tquery);
  ELSE
    RETURN query
    SELECT * FROM skip(1, 'Throw implemented on 4.1.0' || tquery);
  END IF;

END
$BODY$
LANGUAGE plpgsql VOLATILE;
