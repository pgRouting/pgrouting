name: Build for Centos

# manually triggered workflow
# - 5 * 2 * 2 = 20 jobs are triggered
# - So many jobs take too much time

on: [push]

permissions:
  contents: read

jobs:
  build:
    name: centos-7-gcc-4.8.5
    runs-on:
      - self-hosted
      - centos-7 gcc-4.8.5

    steps:
      - uses: actions/checkout@v3

      - name: Configure for gcc
        run: |
          mkdir build
          cd build
          export PATH=${PATH}:/usr/pgsql-15/bin
          cmake3 -DCMAKE_BUILD_TYPE=Release -DBOOST_ROOT:PATH="/opt/boost" ..

      - name: Build
        run: |
          cd build
          make -j 4

      - name: Install
        run: |
          sudo make install

      - name: Test
        run: |
          export PGPORT=5432
          sudo -u postgres createdb -p ${PGPORT}  ___pgr___test___
          sudo -u postgres bash ./tools/testers/pg_prove_tests.sh postgres ${PGPORT}  Release
